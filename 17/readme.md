# Отчет

## Пример 1

### Описание системы

Есть система аренды различных виртуальных серверов. И в нашем сервисе есть множество разных настроек и ньюансов, например таких, что у нас нет машин с диском более `10ТБ` на `x86`, но при этом на `ARM` у нас есть машины до `1000ТБ` и больше и т.д.

### Ошибочное состояние системы

Компания была начинающим стартапом - поэтому весь код писался быстрее человеческой мысли о том как правильно. И в итоге получили следующую схему работы: Есть одна большая конфигурация на которую "cмотрят" (убираем слово "ссылки" при описании дизайна) все объекты по распределению ресурсов и работает это так: Клиенский запрос присылает новое состояние всей конфигурации, мы парсим это состояние и сравниваем типы, далее при выстраивании бызнесс логики начинаем делать различные проверки и если какая то из них не прошла - делаем роллбек

### В чем проблема

* Нет SRP
* Конструируем объекты с невалидным состоянием и принимаем решение по состоянию не на этапе создания объекта, а при выполнении действий

### Как мы можем это исправить

Существующую схему работы можно улучшить так:

* Для каждой компоненты выделяем отдельный класс конфигурации (для настроки облака один класс, для аренды БД другой и т д)
* Делаем классы-фабрики, которые могут сконструировать только валидний инстанс любой конфигурации (созданные инстенс нельзя будет изменять - тут будем придерживаться концепции `copy-on-write`)
* В каждый компонент системы отдаем минимальный набор конфигурации
* Выделяем отдельные классы для состояний (допустим есть класс конфигурации облака и есть настройка - авто-расширение диска при необходимости. В таком случае нужно сделать 2 класса: `BoundedDistSpace` и `UnboundendDiskSpace` - при этом `BoundedDistSpace` - родительский класс принимающий ограничение, а `UnboundendDiskSpace` вызывыет конструктор родителя и передает бесконечность как заданный лимит по диску). Такой подход позволит избежать ошибочных состояний на уровне системы типов

## Пример 2

### Описание системы

Рассмотрим систему полнотекстового поиска для мессенджера. Данная система производит поиск по нескольким базам данных, например таких как: `Users`, `Messages`, `Groups`.

### Ошибочное состояние системы

Вся система была привязана к `PostgreSQL` но после большого наплыва клиентов стало понятно, что система не справляется с нагрузками и нужно менять базу данных например на `MongoDB` и при этом в кратчайшие сроки, чтобы не потерять уважение драгоценных пользователей и деньги :)

### В чем проблема

* изменение базы данных затрагивает все системы т к раньше все напрямую работали с `PostgreSQL`

### Как мы можем это исправить

* Посоветую разработчикам прочитать про `onion architecture` согласно которой нужно было выделять `repository` которая и будет оберткой над конкретной базой данных, чтобы потом пришлось менять только сущность `repository` (в каждом из микросервисов разумеется)
